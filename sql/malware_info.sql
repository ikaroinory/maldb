select malware_info.sha256              as `SHA256`,
       sha1                             as `SHA1`,
       md5                              as `MD5`,
       tlsh                             as `TLSH`,
       permhash                         as `Permhash`,
       name                             as `Sample Name`,
       type                             as `Sample Type`,
       size                             as `Sample Size`,
       category_first                   as `Threat Category 1`,
       category_second                  as `Threat Category 2`,
       category_third                   as `Threat Category 3`,
       threat_name                      as `Threat Name`,
--        threat_label                     as `Threat Label`,
       first_submission_date_virustotal as `First Submission Date (VirusTotal)`,
       last_submission_date_virustotal  as `Last Submission Date (VirusTotal)`,
       last_analysis_date_virustotal    as `Last Analysis Date (VirusTotal)`,
       download_info.source             as `Sample Source`
from malware_info, (
        with mtcr as (
            with mtc as (
                select distinct *
                from malware_threat_category
                where sha256 in (select sha256 from malware_info)
            )
            select *,
                 row_number() over (partition by sha256 order by count desc, category desc) as rank
            from mtc
        )
        select sha256,
               max(case when rank = 1 then category end) as category_first,
               max(case when rank = 2 then category end) as category_second,
               max(case when rank = 3 then category end) as category_third
        from mtcr
        group by sha256
     ) other, download_info
where malware_info.sha256 == other.sha256
  and malware_info.sha256 == download_info.sha256
  and malware_info.sha256 in (select sha256 from download_info);
